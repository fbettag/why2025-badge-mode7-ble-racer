#include "include/math.h"

// Precomputed sine and cosine tables
const int16_t sin_table[SIN_TABLE_SIZE] = {
    0x0000, 0x0064, 0x00c8, 0x012c, 0x0190, 0x01f4, 0x0258, 0x02bc,
    0x031f, 0x0383, 0x03e6, 0x0449, 0x04ac, 0x050f, 0x0571, 0x05d4,
    0x0636, 0x0698, 0x06fa, 0x075c, 0x07bd, 0x081e, 0x087f, 0x08df,
    0x093f, 0x099f, 0x09fe, 0x0a5d, 0x0abc, 0x0b1a, 0x0b78, 0x0bd6,
    0x0c33, 0x0c90, 0x0cec, 0x0d48, 0x0da3, 0x0dfe, 0x0e58, 0x0eb2,
    0x0f0b, 0x0f64, 0x0fbc, 0x1014, 0x106b, 0x10c1, 0x1117, 0x116c,
    0x11c0, 0x1214, 0x1267, 0x12b9, 0x130b, 0x135c, 0x13ac, 0x13fb,
    0x144a, 0x1498, 0x14e5, 0x1531, 0x157c, 0x15c7, 0x1611, 0x165a,
    0x16a2, 0x16e9, 0x172f, 0x1775, 0x17b9, 0x17fd, 0x1840, 0x1882,
    0x18c3, 0x1903, 0x1943, 0x1981, 0x19bf, 0x19fc, 0x1a37, 0x1a72,
    0x1aac, 0x1ae5, 0x1b1d, 0x1b54, 0x1b8a, 0x1bbf, 0x1bf3, 0x1c26,
    0x1c58, 0x1c89, 0x1cb9, 0x1ce8, 0x1d16, 0x1d43, 0x1d6f, 0x1d9a,
    0x1dc4, 0x1ded, 0x1e14, 0x1e3a, 0x1e5f, 0x1e83, 0x1ea6, 0x1ec8,
    0x1ee8, 0x1f08, 0x1f26, 0x1f43, 0x1f5f, 0x1f7a, 0x1f94, 0x1fac,
    0x1fc3, 0x1fd9, 0x1fed, 0x2000, 0x2012, 0x2023, 0x2033, 0x2042,
    0x204f, 0x205c, 0x2067, 0x2071, 0x207a, 0x2081, 0x2087, 0x208c,
    0x2090, 0x2093, 0x2094, 0x2095, 0x2095, 0x2094, 0x2093, 0x2090,
    0x208c, 0x2087, 0x2081, 0x207a, 0x2071, 0x2067, 0x205c, 0x204f,
    0x2042, 0x2033, 0x2023, 0x2012, 0x2000, 0x1fed, 0x1fd9, 0x1fc3,
    0x1fac, 0x1f94, 0x1f7a, 0x1f5f, 0x1f43, 0x1f26, 0x1f08, 0x1ee8,
    0x1ec8, 0x1ea6, 0x1e83, 0x1e5f, 0x1e3a, 0x1e14, 0x1ded, 0x1dc4,
    0x1d9a, 0x1d6f, 0x1d43, 0x1d16, 0x1ce8, 0x1cb9, 0x1c89, 0x1c58,
    0x1c26, 0x1bf3, 0x1bbf, 0x1b8a, 0x1b54, 0x1b1d, 0x1ae5, 0x1aac,
    0x1a72, 0x1a37, 0x19fc, 0x19bf, 0x1981, 0x1943, 0x1903, 0x18c3,
    0x1882, 0x1840, 0x17fd, 0x17b9, 0x1775, 0x172f, 0x16e9, 0x16a2,
    0x165a, 0x1611, 0x15c7, 0x157c, 0x1531, 0x14e5, 0x1498, 0x144a,
    0x13fb, 0x13ac, 0x135c, 0x130b, 0x12b9, 0x1267, 0x1214, 0x11c0,
    0x116c, 0x1117, 0x10c1, 0x106b, 0x1014, 0x0fbc, 0x0f64, 0x0f0b,
    0x0eb2, 0x0e58, 0x0dfe, 0x0da3, 0x0d48, 0x0cec, 0x0c90, 0x0c33,
    0x0bd6, 0x0b78, 0x0b1a, 0x0abc, 0x0a5d, 0x09fe, 0x099f, 0x093f,
    0x08df, 0x087f, 0x081e, 0x07bd, 0x075c, 0x06fa, 0x0698, 0x0636,
    0x05d4, 0x0571, 0x050f, 0x04ac, 0x0449, 0x03e6, 0x0383, 0x031f,
    0x02bc, 0x0258, 0x01f4, 0x0190, 0x012c, 0x00c8, 0x0064, 0x0000,
    0xff9c, 0xff38, 0xfed4, 0xfe70, 0xfe0c, 0xfda8, 0xfd44, 0xfce0,
    0xfc7c, 0xfc18, 0xfbb4, 0xfb50, 0xfaeb, 0xfa87, 0xfa23, 0xf9bf,
    0xf95a, 0xf8f6, 0xf891, 0xf82d, 0xf7c8, 0xf763, 0xf6fe, 0xf699,
    0xf634, 0xf5cf, 0xf569, 0xf504, 0xf49f, 0xf439, 0xf3d3, 0xf36e,
    0xf308, 0xf2a2, 0xf23c, 0xf1d6, 0xf170, 0xf10a, 0xf0a3, 0xf03d,
    0xefd7, 0xef70, 0xef0a, 0xeea3, 0xee3c, 0xedd5, 0xed6e, 0xed07,
    0xeca0, 0xec39, 0xebd1, 0xeb6a, 0xeb02, 0xea9b, 0xea33, 0xe9cb,
    0xe963, 0xe8fb, 0xe893, 0xe82b, 0xe7c3, 0xe75b, 0xe6f2, 0xe68a,
    0xe621, 0xe5b9, 0xe550, 0xe4e7, 0xe47e, 0xe415, 0xe3ac, 0xe343,
    0xe2da, 0xe271, 0xe208, 0xe19f, 0xe135, 0xe0cc, 0xe063, 0xdffa,
    0xdf90, 0xdf27, 0xdebd, 0xde54, 0xddea, 0xdd81, 0xdd17, 0xdcae,
    0xdc44, 0xdbdb, 0xdb71, 0xdb07, 0xda9e, 0xda34, 0xd9ca, 0xd961,
    0xd8f7, 0xd88d, 0xd823, 0xd7ba, 0xd750, 0xd6e6, 0xd67c, 0xd612,
    0xd5a9, 0xd53f, 0xd4d5, 0xd46b, 0xd401, 0xd397, 0xd32e, 0xd2c4,
    0xd25a, 0xd1f0, 0xd186, 0xd11d, 0xd0b3, 0xd049, 0xcfe0, 0xcf76,
    0xcf0c, 0xcea3, 0xce39, 0xcdd0, 0xcd66, 0xccfd, 0xcc93, 0xcc2a,
    0xcbc1, 0xcb58, 0xcaf0, 0xca87, 0xca1e, 0xc9b6, 0xc94d, 0xc8e5,
    0xc87d, 0xc815, 0xc7ad, 0xc745, 0xc6dd, 0xc676, 0xc60f, 0xc5a8,
    0xc541, 0xc4da, 0xc473, 0xc40d, 0xc3a6, 0xc340, 0xc2d9, 0xc273,
    0xc20d, 0xc1a7, 0xc141, 0xc0db, 0xc075, 0xc010, 0xbfab, 0xbf46,
    0xbee1, 0xbe7c, 0xbe17, 0xbdb2, 0xbd4e, 0xbcea, 0xbc85, 0xbc21,
    0xbbbd, 0xbb59, 0xbaf5, 0xba91, 0xba2e, 0xb9cb, 0xb967, 0xb904,
    0xb8a1, 0xb83e, 0xb7dc, 0xb779, 0xb717, 0xb6b5, 0xb653, 0xb5f1,
    0xb58f, 0xb52e, 0xb4cd, 0xb46c, 0xb40b, 0xb3aa, 0xb34a, 0xb2e9,
    0xb289, 0xb229, 0xb1c9, 0xb16a, 0xb10a, 0xb0ab, 0xb04c, 0xafed,
    0xaf8e, 0xaf30, 0xaed2, 0xae74, 0xae16, 0xadb8, 0xad5b, 0xacfd,
    0xaca0, 0xac43, 0xabe7, 0xab8a, 0xab2e, 0xaad1, 0xaa75, 0xaa19,
    0xa9bd, 0xa962, 0xa906, 0xa8ab, 0xa850, 0xa7f5, 0xa79a, 0xa740,
    0xa6e5, 0xa68b, 0xa631, 0xa5d7, 0xa57d, 0xa523, 0xa4ca, 0xa470,
    0xa417, 0xa3be, 0xa365, 0xa30c, 0xa2b3, 0xa25b, 0xa202, 0xa1aa,
    0xa152, 0xa0fa, 0xa0a2, 0xa04b, 0x9ff3, 0x9f9c, 0x9f45, 0x9eee,
    0x9e97, 0x9e40, 0x9dea, 0x9d93, 0x9d3d, 0x9ce7, 0x9c91, 0x9c3b,
    0x9be5, 0x9b90, 0x9b3a, 0x9ae5, 0x9a90, 0x9a3b, 0x99e6, 0x9991,
    0x993d, 0x98e8, 0x9894, 0x9840, 0x97ec, 0x9798, 0x9744, 0x96f1,
    0x969d, 0x964a, 0x95f7, 0x95a4, 0x9551, 0x94fe, 0x94ab, 0x9459,
    0x9406, 0x93b4, 0x9362, 0x9310, 0x92be, 0x926c, 0x921a, 0x91c9,
    0x9177, 0x9126, 0x90d5, 0x9084, 0x9033, 0x8fe2, 0x8f91, 0x8f41,
    0x8ef0, 0x8ea0, 0x8e50, 0x8e00, 0x8db0, 0x8d60, 0x8d10, 0x8cc1,
    0x8c71, 0x8c22, 0x8bd3, 0x8b83, 0x8b34, 0x8ae5, 0x8a97, 0x8a48,
    0x89f9, 0x89ab, 0x895c, 0x890e, 0x88c0, 0x8872, 0x8824, 0x87d6,
    0x8789, 0x873b, 0x86ee, 0x86a0, 0x8653, 0x8606, 0x85b9, 0x856c,
    0x851f, 0x84d2, 0x8486, 0x8439, 0x83ed, 0x83a1, 0x8354, 0x8308,
    0x82bc, 0x8270, 0x8224, 0x81d9, 0x818d, 0x8141, 0x80f6, 0x80aa,
    0x805f, 0x8014, 0x7fc9, 0x7f7e, 0x7f33, 0x7ee9, 0x7e9e, 0x7e53,
    0x7e09, 0x7dbf, 0x7d74, 0x7d2a, 0x7ce0, 0x7c96, 0x7c4c, 0x7c02,
    0x7bb8, 0x7b6f, 0x7b25, 0x7adc, 0x7a92, 0x7a49, 0x7a00, 0x79b7,
    0x796e, 0x7925, 0x78dc, 0x7893, 0x784b, 0x7802, 0x77ba, 0x7771,
    0x7729, 0x76e1, 0x7699, 0x7651, 0x7609, 0x75c1, 0x7579, 0x7531,
    0x74ea, 0x74a2, 0x745b, 0x7413, 0x73cc, 0x7385, 0x733e, 0x72f7,
    0x72b0, 0x7269, 0x7222, 0x71dc, 0x7195, 0x714f, 0x7108, 0x70c2,
    0x707c, 0x7035, 0x6fef, 0x6fa9, 0x6f63, 0x6f1d, 0x6ed7, 0x6e91,
    0x6e4b, 0x6e05, 0x6dc0, 0x6d7a, 0x6d34, 0x6cef, 0x6ca9, 0x6c64,
    0x6c1f, 0x6bd9, 0x6b94, 0x6b4f, 0x6b0a, 0x6ac5, 0x6a80, 0x6a3b,
    0x69f6, 0x69b1, 0x696c, 0x6927, 0x68e3, 0x689e, 0x6859, 0x6815,
    0x67d0, 0x678c, 0x6747, 0x6703, 0x66bf, 0x667b, 0x6636, 0x65f2,
    0x65ae, 0x656a, 0x6526, 0x64e2, 0x649e, 0x645a, 0x6416, 0x63d3,
    0x638f, 0x634b, 0x6308, 0x62c4, 0x6281, 0x623d, 0x61fa, 0x61b7,
    0x6174, 0x6130, 0x60ed, 0x60aa, 0x6067, 0x6024, 0x5fe1, 0x5f9e,
    0x5f5b, 0x5f18, 0x5ed5, 0x5e93, 0x5e50, 0x5e0d, 0x5dcb, 0x5d88,
    0x5d46, 0x5d03, 0x5cc1, 0x5c7f, 0x5c3c, 0x5bfa, 0x5bb8, 0x5b75,
    0x5b33, 0x5af1, 0x5aaf, 0x5a6d, 0x5a2b, 0x59e9, 0x59a7, 0x5965,
    0x5923, 0x58e1, 0x589f, 0x585e, 0x581c, 0x57da, 0x5799, 0x5757,
    0x5716, 0x56d4, 0x5693, 0x5651, 0x5610, 0x55cf, 0x558e, 0x554d,
    0x550c, 0x54cb, 0x548a, 0x5449, 0x5408, 0x53c7, 0x5386, 0x5345,
    0x5305, 0x52c4, 0x5283, 0x5243, 0x5202, 0x51c2, 0x5181, 0x5141,
    0x5100, 0x50c0, 0x5080, 0x5040, 0x5000, 0x4fc0, 0x4f80, 0x4f40,
    0x4f00, 0x4ec0, 0x4e80, 0x4e40, 0x4e00, 0x4dc0, 0x4d80, 0x4d40,
    0x4d00, 0x4cc0, 0x4c80, 0x4c40, 0x4c00, 0x4bc0, 0x4b80, 0x4b40,
    0x4b00, 0x4ac0, 0x4a80, 0x4a40, 0x4a00, 0x49c0, 0x4980, 0x4940,
    0x4900, 0x48c0, 0x4880, 0x4840, 0x4800, 0x47c0, 0x4780, 0x4740,
    0x4700, 0x46c0, 0x4680, 0x4640, 0x4600, 0x45c0, 0x4580, 0x4540,
    0x4500, 0x44c0, 0x4480, 0x4440, 0x4400, 0x43c0, 0x4380, 0x4340,
    0x4300, 0x42c0, 0x4280, 0x4240, 0x4200, 0x41c0, 0x4180, 0x4140,
    0x4100, 0x40c0, 0x4080, 0x4040, 0x4000
};

const int16_t cos_table[SIN_TABLE_SIZE] = {
    0x4000, 0x403f, 0x407e, 0x40bd, 0x40fc, 0x413b, 0x417a, 0x41b9,
    0x41f7, 0x4236, 0x4275, 0x42b3, 0x42f2, 0x4330, 0x436f, 0x43ad,
    0x43ec, 0x442a, 0x4468, 0x44a6, 0x44e4, 0x4522, 0x4560, 0x459e,
    0x45dc, 0x4619, 0x4657, 0x4694, 0x46d2, 0x470f, 0x474c, 0x478a,
    0x47c7, 0x4804, 0x4840, 0x487d, 0x48ba, 0x48f6, 0x4933, 0x496f,
    0x49ab, 0x49e7, 0x4a23, 0x4a5f, 0x4a9b, 0x4ad7, 0x4b12, 0x4b4e,
    0x4b89, 0x4bc4, 0x4bff, 0x4c3a, 0x4c75, 0x4cb0, 0x4ceb, 0x4d25,
    0x4d60, 0x4d9a, 0x4dd5, 0x4e0f, 0x4e49, 0x4e83, 0x4ebc, 0x4ef6,
    0x4f30, 0x4f69, 0x4fa3, 0x4fdc, 0x5015, 0x504e, 0x5087, 0x50c0,
    0x50f8, 0x5131, 0x5169, 0x51a2, 0x51da, 0x5212, 0x524a, 0x5282,
    0x52ba, 0x52f2, 0x532a, 0x5361, 0x5399, 0x53d0, 0x5408, 0x543f,
    0x5476, 0x54ad, 0x54e4, 0x551b, 0x5552, 0x5589, 0x55bf, 0x55f6,
    0x562c, 0x5663, 0x5699, 0x56cf, 0x5705, 0x573b, 0x5771, 0x57a7,
    0x57dd, 0x5812, 0x5848, 0x587d, 0x58b2, 0x58e8, 0x591d, 0x5952,
    0x5987, 0x59bc, 0x59f0, 0x5a25, 0x5a5a, 0x5a8e, 0x5ac2, 0x5af7,
    0x5b2b, 0x5b5f, 0x5b93, 0x5bc7, 0x5bfb, 0x5c2e, 0x5c62, 0x5c96,
    0x5cc9, 0x5cfc, 0x5d30, 0x5d63, 0x5d96, 0x5dc9, 0x5dfc, 0x5e2f,
    0x5e62, 0x5e95, 0x5ec7, 0x5efa, 0x5f2d, 0x5f5f, 0x5f92, 0x5fc4,
    0x5ff6, 0x6029, 0x605b, 0x608d, 0x60bf, 0x60f1, 0x6123, 0x6155,
    0x6187, 0x61b9, 0x61ea, 0x621c, 0x624e, 0x627f, 0x62b0, 0x62e2,
    0x6313, 0x6344, 0x6375, 0x63a6, 0x63d7, 0x6408, 0x6439, 0x6469,
    0x649a, 0x64cb, 0x64fb, 0x652c, 0x655c, 0x658c, 0x65bc, 0x65ed,
    0x661d, 0x664d, 0x667d, 0x66ad, 0x66dd, 0x670d, 0x673d, 0x676c,
    0x679c, 0x67cc, 0x67fb, 0x682b, 0x685a, 0x6889, 0x68b9, 0x68e8,
    0x6917, 0x6946, 0x6975, 0x69a4, 0x69d3, 0x6a02, 0x6a30, 0x6a5f,
    0x6a8e, 0x6abc, 0x6aeb, 0x6b19, 0x6b48, 0x6b76, 0x6ba4, 0x6bd2,
    0x6c00, 0x6c2e, 0x6c5c, 0x6c8a, 0x6cb8, 0x6ce6, 0x6d13, 0x6d41,
    0x6d6f, 0x6d9c, 0x6dca, 0x6df7, 0x6e24, 0x6e52, 0x6e7f, 0x6eac,
    0x6ed9, 0x6f06, 0x6f33, 0x6f60, 0x6f8d, 0x6fba, 0x6fe7, 0x7014,
    0x7040, 0x706d, 0x709a, 0x70c6, 0x70f3, 0x711f, 0x714c, 0x7178,
    0x71a4, 0x71d0, 0x71fd, 0x7229, 0x7255, 0x7281, 0x72ad, 0x72d9,
    0x7305, 0x7331, 0x735c, 0x7388, 0x73b4, 0x73df, 0x740b, 0x7436,
    0x7462, 0x748d, 0x74b8, 0x74e4, 0x750f, 0x753a, 0x7565, 0x7590,
    0x75bb, 0x75e6, 0x7611, 0x763c, 0x7667, 0x7692, 0x76bc, 0x76e7,
    0x7712, 0x773c, 0x7767, 0x7791, 0x77bc, 0x77e6, 0x7810, 0x783b,
    0x7865, 0x788f, 0x78b9, 0x78e3, 0x790d, 0x7937, 0x7961, 0x798b,
    0x79b5, 0x79df, 0x7a09, 0x7a32, 0x7a5c, 0x7a86, 0x7aaf, 0x7ad9,
    0x7b02, 0x7b2b, 0x7b55, 0x7b7e, 0x7ba7, 0x7bd0, 0x7bf9, 0x7c22,
    0x7c4b, 0x7c74, 0x7c9d, 0x7cc6, 0x7cef, 0x7d17, 0x7d40, 0x7d69,
    0x7d91, 0x7dba, 0x7de2, 0x7e0b, 0x7e33, 0x7e5b, 0x7e83, 0x7eab,
    0x7ed3, 0x7efb, 0x7f23, 0x7f4b, 0x7f73, 0x7f9a, 0x7fc2, 0x7fe9
};

// Matrix operations
void mat3_identity(mat3_t *m) {
    m->m[0][0] = FIXED16_ONE; m->m[0][1] = 0;           m->m[0][2] = 0;
    m->m[1][0] = 0;           m->m[1][1] = FIXED16_ONE; m->m[1][2] = 0;
    m->m[2][0] = 0;           m->m[2][1] = 0;           m->m[2][2] = FIXED16_ONE;
}

void mat3_rotation(mat3_t *m, fixed16_t angle) {
    fixed16_t cos_a = fixed_cos(angle);
    fixed16_t sin_a = fixed_sin(angle);
    
    m->m[0][0] = cos_a;  m->m[0][1] = -sin_a; m->m[0][2] = 0;
    m->m[1][0] = sin_a;  m->m[1][1] = cos_a;  m->m[1][2] = 0;
    m->m[2][0] = 0;      m->m[2][1] = 0;      m->m[2][2] = FIXED16_ONE;
}

void mat3_multiply(mat3_t *result, const mat3_t *a, const mat3_t *b) {
    for (int i = 0; i < 3; i++) {
        for (int j = 0; j < 3; j++) {
            result->m[i][j] = fixed_mul(a->m[i][0], b->m[0][j]) +
                              fixed_mul(a->m[i][1], b->m[1][j]) +
                              fixed_mul(a->m[i][2], b->m[2][j]);
        }
    }
}

vec2_t mat3_transform(const mat3_t *m, vec2_t v) {
    vec2_t result;
    result.x = fixed_mul(m->m[0][0], v.x) + fixed_mul(m->m[0][1], v.y) + m->m[0][2];
    result.y = fixed_mul(m->m[1][0], v.x) + fixed_mul(m->m[1][1], v.y) + m->m[1][2];
    return result;
}